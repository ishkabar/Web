name: Build & Deploy Web
on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: web-deploy
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  IMAGE_PORTFOLIO: ghcr.io/${{ github.repository_owner }}/web-portfolio
  IMAGE_OGUR: ghcr.io/${{ github.repository_owner }}/web-ogur

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build+Push portfolio (SSR)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./portfolio/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_GA_ID_PORTFOLIO=${{ secrets.NEXT_PUBLIC_GA_ID_PORTFOLIO }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/web-portfolio:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/web-portfolio:sha-${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/web-portfolio:latest
          platforms: linux/amd64
          provenance: false

      - name: Build+Push ogur (SSR)
        uses: docker/build-push-action@v6
        with:
          context: ./ogur-next
          file: ./ogur-next/Dockerfile
          build-args: |
            NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/web-ogur:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/web-ogur:sha-${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/web-ogur:latest
          platforms: linux/amd64
          provenance: false

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.2.2
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          PORTFOLIO_DOMAIN: ${{ secrets.PORTFOLIO_DOMAIN }}
          OGUR_DOMAIN: ${{ secrets.OGUR_DOMAIN }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.NEXT_PUBLIC_GA_ID }}
          NEXT_PUBLIC_GA_ID_PORTFOLIO: ${{ secrets.NEXT_PUBLIC_GA_ID_PORTFOLIO }}
          IMAGE_TAG: ${{ github.sha }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: GITHUB_ACTOR,GITHUB_TOKEN,GITHUB_OWNER,PORTFOLIO_DOMAIN,OGUR_DOMAIN,NEXT_PUBLIC_GA_ID,NEXT_PUBLIC_GA_ID_PORTFOLIO,IMAGE_TAG
          script: |
            set -eo pipefail
            GH_OWNER="${GITHUB_OWNER:-ishkabar}"
            PORTFOLIO_DOMAIN="${PORTFOLIO_DOMAIN:-dkarczewski.com}"
            OGUR_DOMAIN="${OGUR_DOMAIN:-ogur.dev}"
            NEXT_PUBLIC_GA_ID="${NEXT_PUBLIC_GA_ID}"
            NEXT_PUBLIC_GA_ID_PORTFOLIO="${NEXT_PUBLIC_GA_ID_PORTFOLIO}"
            IMAGE_TAG_SAFE="${IMAGE_TAG:-latest}"
            docker network ls --format '{{.Name}}' | grep -qx web || docker network create web
            mkdir -p ~/web/portfolio ~/web/ogur
            cat > ~/web/portfolio/docker-compose.app.yml <<'YML'
            services:
              portfolio:
                image: ghcr.io/${GH_OWNER}/web-portfolio:${TAG:-latest}
                container_name: portfolio_web
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - NEXT_PUBLIC_GA_ID_PORTFOLIO=${NEXT_PUBLIC_GA_ID_PORTFOLIO}
                networks: [ web ]
                labels:
                  traefik.enable: "true"
                  traefik.docker.network: "web"
                  traefik.http.routers.portfolio.rule: "Host(`${PORTFOLIO_DOMAIN}`) || Host(`www.${PORTFOLIO_DOMAIN}`)"
                  traefik.http.routers.portfolio.entrypoints: "websecure"
                  traefik.http.routers.portfolio.tls.certresolver: "le"
                  traefik.http.services.portfolio.loadbalancer.server.port: "3000"
                  traefik.http.routers.portfolio_http.rule: "Host(`${PORTFOLIO_DOMAIN}`) || Host(`www.${PORTFOLIO_DOMAIN}`)"
                  traefik.http.routers.portfolio_http.entrypoints: "web"
                  traefik.http.routers.portfolio_http.middlewares: "forcehttps@docker"
                  traefik.http.middlewares.forcehttps.redirectscheme.scheme: "https"
                  traefik.http.middlewares.forcehttps.redirectscheme.permanent: "true"
                  traefik.http.routers.portfolio.middlewares: "www2apex@docker"
                  traefik.http.middlewares.www2apex.redirectregex.regex: "^https?://www\\.(.*)"
                  traefik.http.middlewares.www2apex.redirectregex.replacement: "https://$1"
                  traefik.http.middlewares.www2apex.redirectregex.permanent: "true"
            networks:
              web:
                external: true
            YML
            cat > ~/web/portfolio/.env <<EOF
            GH_OWNER=${GH_OWNER}
            TAG=sha-${IMAGE_TAG_SAFE}
            PORTFOLIO_DOMAIN=${PORTFOLIO_DOMAIN}
            NEXT_PUBLIC_GA_ID_PORTFOLIO=${NEXT_PUBLIC_GA_ID_PORTFOLIO}
            EOF
            cat > ~/web/ogur/docker-compose.app.yml <<'YML'
            services:
              ogur:
                image: ghcr.io/${GH_OWNER}/web-ogur:${TAG:-latest}
                container_name: ogur_web
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=3000
                  - REDIS_URL=redis://bot-redis:6379
                  - HOSTNAME=0.0.0.0
                  - NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
                networks:
                  - web
                  - ogursentinel_internal
                labels:
                  traefik.enable: "true"
                  traefik.docker.network: "web"
                  traefik.http.routers.ogur.rule: "Host(`${OGUR_DOMAIN}`) || Host(`www.${OGUR_DOMAIN}`)"
                  traefik.http.routers.ogur.entrypoints: "websecure"
                  traefik.http.routers.ogur.tls.certresolver: "le"
                  traefik.http.services.ogur.loadbalancer.server.port: "3000"
                  traefik.http.routers.ogur_http.rule: "Host(`${OGUR_DOMAIN}`) || Host(`www.${OGUR_DOMAIN}`)"
                  traefik.http.routers.ogur_http.entrypoints: "web"
                  traefik.http.routers.ogur_http.middlewares: "forcehttps@docker"
                  traefik.http.middlewares.forcehttps.redirectscheme.scheme: "https"
                  traefik.http.middlewares.forcehttps.redirectscheme.permanent: "true"
                  traefik.http.routers.ogur.middlewares: "www2apex@docker"
                  traefik.http.middlewares.www2apex.redirectregex.regex: "^https?://www\\.(.*)"
                  traefik.http.middlewares.www2apex.redirectregex.replacement: "https://$1"
                  traefik.http.middlewares.www2apex.redirectregex.permanent: "true"
            networks:
              web:
                external: true
              ogursentinel_internal:
                external: true
            YML
            cat > ~/web/ogur/.env <<EOF
            GH_OWNER=${GH_OWNER}
            TAG=sha-${IMAGE_TAG_SAFE}
            OGUR_DOMAIN=${OGUR_DOMAIN}
            NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
            EOF
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
            docker compose -f ~/web/portfolio/docker-compose.app.yml pull
            docker compose -f ~/web/portfolio/docker-compose.app.yml up -d --force-recreate --remove-orphans
            docker compose -f ~/web/ogur/docker-compose.app.yml pull
            docker compose -f ~/web/ogur/docker-compose.app.yml up -d --force-recreate --remove-orphans
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"