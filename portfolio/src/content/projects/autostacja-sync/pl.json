{
  "title": "AutostacjaSync - Synchronizacja Dokumentów z Prestiž ERP",
  "summary": "Usługa Windows (.NET 8) synchronizująca dokumenty XML z zewnętrznych systemów do ERP Prestiž poprzez bazę Firebird.",
  "content": "## Przegląd\n\nSystem monitoruje katalog sieciowy, parsuje różne formaty XML i importuje dokumenty do bufora zewnętrznego (URZZEWNAGL/URZZEWNPOZ) w systemie Prestiž. Obsługuje faktury, przyjęcia magazynowe, korekty, paragony i dokumenty kasowe z automatycznym mapowaniem kontrahentów i katalogu towarowego.\n\n## Funkcjonalności\n\n### Obsługiwane Dokumenty\n\n- **FA/FS** - Faktury sprzedaży (z NIP i detaliczne bez NIP)\n- **PAR/KPAR** - Paragony i korekty paragonów\n- **PZ/WZ** - Przyjęcia i wydania magazynowe\n- **KP/KW** - Dokumenty kasowe (wpłaty/wypłaty)\n- **PKW/PK** - Przesunięcia międzymagazynowe\n- **ZPZ** - Zewnętrzne zamówienia przyjęcia\n\n### Przepływ Pracy\n\n1. Usługa wykrywa nowy plik XML w katalogu sieciowym\n2. TemplateDetector identyfikuje typ dokumentu po strukturze\n3. Odpowiedni parser (SpFvatParser, MgPkwParser) przetwarza XML\n4. ContractorService zapewnia istnienie kontrahenta:\n   - Z NIP → wyszukuje lub tworzy firmę (TYPKONTRAH=1)\n   - Bez NIP (paragon) → używa kontrahenta detalicznego z konfiguracji\n   - Bez NIP (faktura) → tworzy osobę fizyczną (TYPKONTRAH=2)\n5. System tworzy nagłówek dokumentu (URZZEWNAGL) i pozycje (URZZEWNPOZ)\n6. Dla faktur detalicznych aktualizuje ID_DEFDOK na typ 10\n7. Plik trafia do Archive (sukces) lub Failed (błąd)\n\n## Architektura\n\n### Clean Architecture (DDD Lite)\n\n```\nAutostacjaSync.Domain        - ValueObjects, interfejsy procedur, encje\nAutostacjaSync.Application   - serwisy, CQRS commands, mappery\nAutostacjaSync.Infrastructure - procedury Firebird, EF Core, parsery XML\nAutostacjaSync.Host          - Worker service, DI\n```\n\n### Baza Firebird (Prestiž ERP)\n\nKluczowe tabele:\n\n- **KONTRAH** - kontrahenci (UNIQUE na NAZWASKR i NRKONTRAH)\n- **DANEKONTRAH** - dane adresowe (NIP, adres, ID_KRAJ)\n- **URZZEWNAGL/URZZEWNPOZ** - bufor dokumentów zewnętrznych\n- **KARTOTEKA** - katalog towarowy\n- **KRAJ** - słownik krajów (ISO2 → ID_KRAJ)\n- **SLOWNIK** - słownik księgowy (trigger KONTRAH_BI auto-insert)\n\n### Procedury Składowane\n\n- **ARIT_AUTOSTACJA_ADD_CONTRACTOR** - wyszukuje/tworzy kontrahenta\n  - Dla TYPKONTRAH=2 dodaje numer do nazwy: \"Jan Nowak (10821)\"\n  - Generuje NRKONTRAH sprawdzając KONTRAH i SLOWNIK\n  - Trigger automatycznie wstawia rekord do SLOWNIK\n- **ARIT_AUTOSTACJA_ADD_ITEM** - wyszukuje/tworzy pozycję katalogową\n- **URZZEWNAGL_ADD_10** - tworzy nagłówek dokumentu\n- **URZZEWNPOZ_ADD_10** - dodaje pozycję dokumentu\n\n## Stack Technologiczny\n\n- **.NET 8** - Worker Service\n- **Firebird 3/4** - baza danych ERP\n- **LinqToDB + EF Core** - dostęp do danych\n- **MediatR** - CQRS pattern\n- **NLog** - logowanie\n- **ADO.NET** - wywołania procedur składowanych\n\n## Wyzwania\n\n### Unikalne Ograniczenia\n\n- **NAZWASKR** - constraint UNIQUE(BAZAKONTRAH, NAZWASKR) wymaga unikalnych nazw\n  - Rozwiązanie: dla osób fizycznych dodajemy numer \"(NRKONTRAH)\"\n- **NRKONTRAH** - musi być unikalny zarówno w KONTRAH jak i SLOWNIK\n  - Rozwiązanie: sprawdzamy obie tabele przy generowaniu\n\n### Logika Kontrahentów\n\nDokument **Z NIP**:\n```\n1. Szukaj w DANEKONTRAH po NIP\n2. Znaleziono → użyj ID_KONTRAH\n3. Nie znaleziono → utwórz firmę (TYPKONTRAH=1)\n```\n\nDokument **BEZ NIP**:\n```\nPAR/KPAR → DetailContractor z konfiguracji\nFS/FA → nowa osoba fizyczna (TYPKONTRAH=2)\n        + UPDATE ID_DEFDOK 5→10 (faktura detaliczna)\nInne → ContractorId=1 (jednorazowy)\n```\n\n### Mapowanie Krajów\n\nSystem mapuje kody ISO2 na ID_KRAJ z tabeli KRAJ:\n```csharp\n\"PL\" => 1,      \"DE\" => 10011, \"CZ\" => 10017,\n\"SK\" => 10022,  \"AT\" => 10001, \"FR\" => 10005\n```\n\n### Pooling Połączeń Firebird\n\nWspółdzielenie połączeń między EF Core DbContext a procedurami składowanymi powodowało SocketException. Rozwiązanie: niezależne połączenia dla procedur z `ConnectionLifeTime=60`.\n\n### Korekty Dokumentów\n\nPrestiž zmienia kolejność pozycji podczas realizacji, więc mapowanie korekt wymaga dopasowania po ID_KARTOTEKA zamiast numerów pozycji z XML.\n\n## Konfiguracja\n\n```json\n{\n  \"ConnectionStrings\": {\n    \"Firebird\": \"Server=...;Database=...;ConnectionLifeTime=60\"\n  },\n  \"Sync\": {\n    \"WatchPath\": \"\\\\\\\\server\\\\share\\\\IMP_FK\",\n    \"ArchivePath\": \"\\\\\\\\server\\\\share\\\\IMP_FK\\\\Archive\",\n    \"PollingIntervalSeconds\": 15\n  },\n  \"DetailContractor\": {\n    \"Id\": 10818,\n    \"Code\": \"DETAL\"\n  },\n  \"ExternalDocuments\": {\n    \"DefaultUserCode\": \"MWD\"\n  }\n}\n```"
}